<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GitHub Authentication</title>
  <script>
    // Decap CMS 认证处理脚本
    (function() {
      // 获取 URL 参数
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');
      const error = params.get('error');
      
      console.log('Auth page loaded with params:', { code, state, error });
      
      if (error) {
        console.error('Authentication error:', error);
        if (window.opener) {
          window.opener.postMessage({
            type: 'authorization:github:error',
            error: error
          }, window.location.origin);
          window.close();
        }
        return;
      }
      
      if (code) {
        console.log('Authentication successful, sending message to parent');
        
        // 发送认证成功消息给父窗口
        if (window.opener) {
          window.opener.postMessage({
            type: 'authorization:github:success',
            provider: 'github',
            code: code,
            state: state
          }, window.location.origin);
          
          // 稍等一下再关闭窗口
          setTimeout(() => {
            window.close();
          }, 1000);
        } else {
          // 如果没有父窗口，跳转回 admin
          window.location.href = '/admin/';
        }
      } else {
        // 没有认证码，需要开始认证流程
        const provider = params.get('provider');
        if (provider === 'github') {
          const clientId = 'Ov23lisJIWDlWIG2mY4u';
          const redirectUri = encodeURIComponent(window.location.href.split('?')[0]);
          const scope = params.get('scope') || 'repo';
          const stateParam = Math.random().toString(36).substring(2);
          
          const githubUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}&state=${stateParam}`;
          
          console.log('Redirecting to GitHub:', githubUrl);
          window.location.href = githubUrl;
        }
      }
    })();
  </script>
</head>
<body>
  <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif;">
    <div style="text-align: center;">
      <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p>Processing authentication...</p>
    </div>
  </div>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</body>
</html> 