<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GitHub Authentication</title>
  <script>
    // Decap CMS 认证处理脚本
    (function() {
      // 获取 URL 参数
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');
      const error = params.get('error');
      
      console.log('Auth page loaded with params:', { code, state, error });
      
      if (error) {
        console.error('Authentication error:', error);
        if (window.opener) {
          window.opener.postMessage({
            type: 'authorization:github:error',
            error: error
          }, window.location.origin);
          window.close();
        }
        return;
      }
      
      if (code) {
        console.log('Authentication successful, code received:', code);
        console.log('State:', state);
        console.log('Window opener exists:', !!window.opener);
        console.log('Window opener closed:', window.opener ? window.opener.closed : 'N/A');
        
        // 显示认证成功信息
        document.querySelector('p').innerHTML = `
          <strong>认证成功！</strong><br>
          Code: ${code.substring(0, 10)}...<br>
          State: ${state}<br>
          正在处理认证信息...
        `;
        
        // 发送认证成功消息给父窗口
        if (window.opener && !window.opener.closed) {
          // 尝试多种消息格式，确保 CMS 能接收到
          try {
            // Decap CMS 期望的格式
            window.opener.postMessage(
              'authorization:github:success:' + JSON.stringify({
                provider: 'github',
                code: code,
                state: state
              }), 
              window.location.origin
            );
            
            // 备用格式
            window.opener.postMessage({
              type: 'authorization:github:success',
              provider: 'github',
              code: code,
              state: state
            }, window.location.origin);
            
            console.log('Messages sent to parent window');
            
            // 稍等一下再关闭窗口
            setTimeout(() => {
              window.close();
            }, 1000);
          } catch (e) {
            console.error('Failed to send message:', e);
            // 如果发送消息失败，跳转回 admin
            window.location.href = '/admin/';
          }
        } else {
          // 如果没有父窗口，跳转回 admin 并携带认证信息
          console.log('No parent window, redirecting to admin with auth data');
          const authDataEncoded = btoa(JSON.stringify({
            provider: 'github',
            code: code,
            state: state
          }));
          window.location.href = '/admin/#auth=' + authDataEncoded;
        }
      } else {
        // 没有认证码，需要开始认证流程
        const provider = params.get('provider');
        if (provider === 'github') {
          const clientId = 'Ov23lisJIWDlWIG2mY4u';
          const redirectUri = encodeURIComponent(window.location.href.split('?')[0]);
          const scope = params.get('scope') || 'repo';
          const stateParam = Math.random().toString(36).substring(2);
          
          const githubUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}&state=${stateParam}`;
          
          console.log('Redirecting to GitHub:', githubUrl);
          window.location.href = githubUrl;
        }
      }
    })();
  </script>
</head>
<body>
  <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif;">
    <div style="text-align: center;">
      <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p>Processing authentication...</p>
    </div>
  </div>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</body>
</html> 