<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GitHub Authentication</title>
  <script>
    // Decap CMS 认证处理脚本
    document.addEventListener('DOMContentLoaded', function() {
      // 获取 URL 参数
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');
      const error = params.get('error');
      
      console.log('Auth page loaded with params:', { code, state, error });
      console.log('Current URL:', window.location.href);
      
      // 更新页面内容显示调试信息
      const statusElement = document.querySelector('p');
      if (statusElement) {
        statusElement.innerHTML = `
          <strong>认证页面已加载</strong><br>
          Code: ${code ? code.substring(0, 15) + '...' : '无'}<br>
          State: ${state || '无'}<br>
          Error: ${error || '无'}<br>
          正在处理...
        `;
      }
      
      if (error) {
        console.error('Authentication error:', error);
        if (window.opener) {
          window.opener.postMessage({
            type: 'authorization:github:error',
            error: error
          }, window.location.origin);
          window.close();
        }
        return;
      }
      
      if (code) {
        console.log('Authentication successful, code received:', code);
        console.log('State:', state);
        console.log('Window opener exists:', !!window.opener);
        console.log('Window opener closed:', window.opener ? window.opener.closed : 'N/A');
        
        // 显示认证成功信息
        const statusElement = document.querySelector('p');
        if (statusElement) {
          statusElement.innerHTML = `
            <strong>✅ 认证成功！</strong><br>
            Code: ${code.substring(0, 10)}...<br>
            State: ${state}<br>
            Window opener: ${window.opener ? '存在' : '不存在'}<br>
            正在处理认证信息...
          `;
        }
        
        // 无论是否有父窗口，都先尝试存储认证信息并跳转
        console.log('Storing auth data and redirecting...');
        
        try {
          // 存储认证信息到 localStorage
          const authData = {
            provider: 'github',
            code: code,
            state: state,
            timestamp: Date.now()
          };
          
          localStorage.setItem('netlify-cms-auth', JSON.stringify(authData));
          console.log('Auth data stored to localStorage');
          
          // 如果有父窗口，尝试发送消息
          if (window.opener && !window.opener.closed) {
            console.log('Sending message to parent window...');
            
            // 发送多种格式的消息
            window.opener.postMessage(
              'authorization:github:success:' + JSON.stringify(authData), 
              window.location.origin
            );
            
            window.opener.postMessage({
              type: 'authorization:github:success',
              ...authData
            }, window.location.origin);
            
            console.log('Messages sent, waiting before closing...');
            
            setTimeout(() => {
              console.log('Closing popup window');
              window.close();
            }, 2000);
          } else {
            console.log('No parent window or parent closed, redirecting directly');
            // 直接跳转到 admin 页面
            setTimeout(() => {
              window.location.href = '/admin/';
            }, 2000);
          }
        } catch (e) {
          console.error('Error in auth processing:', e);
          // 出错时也跳转回 admin
          setTimeout(() => {
            window.location.href = '/admin/';
          }, 2000);
        }
      } else {
        // 没有认证码，需要开始认证流程
        const provider = params.get('provider');
        if (provider === 'github') {
          const clientId = 'Ov23lisJIWDlWIG2mY4u';
          const redirectUri = encodeURIComponent(window.location.href.split('?')[0]);
          const scope = params.get('scope') || 'repo';
          const stateParam = Math.random().toString(36).substring(2);
          
          const githubUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}&state=${stateParam}`;
          
          console.log('Redirecting to GitHub:', githubUrl);
          window.location.href = githubUrl;
        }
      }
    });
  </script>
</head>
<body>
  <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif;">
    <div style="text-align: center;">
      <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p>Processing authentication...</p>
    </div>
  </div>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</body>
</html> 