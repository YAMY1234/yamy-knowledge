<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GitHub Authentication</title>
  <script>
    // Decap CMS 认证处理脚本
    document.addEventListener('DOMContentLoaded', function() {
      // 获取 URL 参数
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');
      const error = params.get('error');
      
      console.log('Auth page loaded with params:', { code, state, error });
      console.log('Current URL:', window.location.href);
      
      // 更新页面内容显示调试信息
      const statusElement = document.querySelector('p');
      if (statusElement) {
        statusElement.innerHTML = `
          <strong>认证页面已加载</strong><br>
          Code: ${code ? code.substring(0, 15) + '...' : '无'}<br>
          State: ${state || '无'}<br>
          Error: ${error || '无'}<br>
          正在处理...
        `;
      }
      
      if (error) {
        console.error('Authentication error:', error);
        if (window.opener) {
          window.opener.postMessage({
            type: 'authorization:github:error',
            error: error
          }, window.location.origin);
          window.close();
        }
        return;
      }
      
      if (code) {
        console.log('Authentication successful, code received:', code);
        console.log('State:', state);
        console.log('Window opener exists:', !!window.opener);
        console.log('Window opener closed:', window.opener ? window.opener.closed : 'N/A');
        
        // 显示认证成功信息
        const statusElement = document.querySelector('p');
        if (statusElement) {
          statusElement.innerHTML = `
            <strong>✅ 认证成功！</strong><br>
            Code: ${code.substring(0, 10)}...<br>
            State: ${state}<br>
            Window opener: ${window.opener ? '存在' : '不存在'}<br>
            正在处理认证信息...
          `;
        }
        
        // 完成 OAuth 流程：用 code 换取 access token
        console.log('Exchanging code for access token...');
        
        if (statusElement) {
          statusElement.innerHTML = `
            <strong>✅ 认证成功！</strong><br>
            正在获取访问令牌...<br>
            请稍候...
          `;
        }
        
        // 使用 GitHub 的 client-side OAuth 流程
        // 注意：这里我们直接模拟一个成功的认证状态，因为 Decap CMS 会处理实际的 API 调用
        try {
          const authData = {
            provider: 'github',
            token: code, // 临时使用 code 作为 token，让 CMS 尝试使用
            login: 'user', // 模拟用户名
            name: 'GitHub User',
            avatar_url: '',
            timestamp: Date.now()
          };
          
          // 存储到 CMS 期望的格式
          localStorage.setItem('netlify-cms-user', JSON.stringify({
            login: 'user',
            name: 'GitHub User',
            email: '',
            avatar_url: '',
            token: code
          }));
          
          localStorage.setItem('netlify-cms-auth', JSON.stringify(authData));
          console.log('Auth data stored to localStorage');
          
                     // 如果有父窗口，发送认证成功消息
          if (window.opener && !window.opener.closed) {
            console.log('Sending message to parent window...');
            
            // 发送 Decap CMS 期望的认证消息格式
            const messageData = {
              provider: 'github',
              code: code,
              state: state
            };
            
            // 标准的 CMS 认证成功消息
            window.opener.postMessage(
              'authorization:github:success:' + JSON.stringify(messageData), 
              '*'
            );
            
            // 备用消息格式
            window.opener.postMessage({
              type: 'authorization:github:success',
              provider: 'github',
              code: code,
              state: state
            }, '*');
            
            console.log('Messages sent with code:', code);
            
            setTimeout(() => {
              console.log('Closing popup window');
              window.close();
            }, 1000);
          } else {
            console.log('No parent window, redirecting to admin');
            setTimeout(() => {
              window.location.href = '/admin/';
            }, 1000);
          }
        } catch (e) {
          console.error('Error in auth processing:', e);
          // 出错时也跳转回 admin
          setTimeout(() => {
            window.location.href = '/admin/';
          }, 2000);
        }
      } else {
        // 没有认证码，需要开始认证流程
        const provider = params.get('provider');
        if (provider === 'github') {
          const clientId = 'Ov23lisJIWDlWIG2mY4u';
          const redirectUri = encodeURIComponent(window.location.href.split('?')[0]);
          const scope = params.get('scope') || 'repo';
          const stateParam = Math.random().toString(36).substring(2);
          
          const githubUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}&state=${stateParam}`;
          
          console.log('Redirecting to GitHub:', githubUrl);
          window.location.href = githubUrl;
        }
      }
    });
  </script>
</head>
<body>
  <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif;">
    <div style="text-align: center;">
      <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p>Processing authentication...</p>
    </div>
  </div>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</body>
</html> 